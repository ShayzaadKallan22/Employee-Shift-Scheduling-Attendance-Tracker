<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Azania - View All Notifications</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta
      content="Employee Management, Staff Management, Shifts"
      name="keywords"
    />
    <meta
      content="Comprehensive employee management system for shift scheduling, payroll, and leave management"
      name="description"
    />

    <!-- Favicon -->
    <link href="img/favicon.ico" rel="icon" />

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />
    <link
      href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css"
      rel="stylesheet"
    />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet" />

    <style>
      .navbar.sticky-top {
        z-index: 1000; /* Ensure navbar is above other elements */
      }
      .notification-card.empty-state {
        text-align: center;
        background-color: #1f2937;
        border-left: 4px solid #4b5563;
      }
      body {
        margin: 0;
        padding: 0;
      }
      .content {
        margin-left: 260px;
      }
      .content .container-fluid {
        padding-left: 20px;
        padding-right: 20px;
      }
      .stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #191c24;
        border-radius: 8px;
      }
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 260px;
        height: 100vh;
        background-color: #191c24;
        z-index: 1000;
        overflow-y: auto;
      }
      .content.expanded {
        margin-left: 0;
        width: 100%;
      }
      .number-notifications {
        font-size: 1.5rem;
        font-weight: 700;
        color: #ffffff;
        white-space: nowrap;
      }
      .btn-mark-as-read {
        background-color: #2563eb;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .btn-mark-as-read:hover {
        background-color: #1d4ed8;
      }
      .filter-card {
        background-color: #191c24;
        border: 1px solid #2a2e38;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }
      .filter-content {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
      }
      .search-wrapper {
        display: flex;
        align-items: center;
        border: 1px solid #2a2e38;
        border-radius: 6px;
        overflow: hidden;
        background-color: #2a2e38;
      }
      .icon-search {
        padding: 10px;
        height: 45px;
        border-top: 1px solid #2a2e38;
        border-left: 1px solid #2a2e38;
        border-bottom: 1px solid #2a2e38;
        color: #9ca3af;
      }
      .search-input {
        border: none;
        padding: 10px;
        width: 200px;
        height: 45px;
        border-top: 1px solid #2a2e38;
        border-bottom: 1px solid #2a2e38;
        border-right: 1px solid #2a2e38;
        font-size: 0.875rem;
        background-color: #2a2e38;
        color: #e5e7eb;
      }
      .search-input:focus {
        outline: none;
        box-shadow: none;
      }
      .search-input::placeholder {
        color: #9ca3af;
      }
      .filter-select {
        padding: 10px;
        border: 1px solid #2a2e38;
        border-radius: 6px;
        border: 1px solid #2a2e38;
        font-size: 0.875rem;
        background-color: #2a2e38;
        color: #e5e7eb;
        width: 200px;
      }
      .filter-select:focus {
        outline: none;
        border-color: #2563eb;
      }
      .filter-select option {
        background-color: #2a2e38;
        color: #e5e7eb;
      }
      .tabs-list {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .tab {
        background-color: #2a2e38;
        color: #e5e7eb;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.875rem;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
      }
      .tab.active,
      .tab:hover {
        background-color: #2563eb;
        color: #ffffff;
      }
      .tab-badge {
        background-color: #dc2626;
        color: #ffffff;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.75rem;
        margin-left: 5px;
      }
      .notification-card {
        background-color: #191c24;
        border: 1px solid #2a2e38;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .notification-card.message {
        /* Ensure message notifications don't disappear */
      }
      .notification-card.disappear:not(.message) {
        opacity: 0;
        transform: translateY(20px);
      }
      .notification-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .notification-card.unread {
        border-left: 4px solid #2563eb;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .card-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .card-icon {
        font-size: 1.5rem;
        color: #e5e7eb;
      }
      .card-left h3 {
        font-size: 1rem;
        font-weight: 500;
        color: #ffffff;
        margin: 0;
      }
      .card-left p {
        font-size: 0.75rem;
        color: #9ca3af;
        margin: 0;
      }
      .card-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .category-badge {
        display: inline-block;
        background-color: #2a2e38;
        color: #e5e7eb;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-top: 4px;
      }
      .badge-medium {
        background-color: #dcfce7;
        color: #16a34a;
      }
      .badge-high {
        background-color: #fee2e2;
        color: #dc2626;
      }
      .timestamp {
        font-size: 0.75rem;
        color: #9ca3af;
      }
      .card-content p {
        font-size: 0.875rem;
        color: #e5e7eb;
        margin-bottom: 10px;
      }
      .card-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: flex-start; /* Changed from flex-end to flex-start */
        margin-left: 54px; /* Matches the icon + text indentation */
        padding-top: 10px;
        border-top: 1px solid #2a2e38; /* Optional: adds a subtle separator */
      }
      .btn-primary {
        background-color: #2563eb;
        color: #ffffff;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .btn-primary:hover {
        background-color: #1d4ed8;
      }
      .btn-action {
        background-color: #2563eb;
        color: white;
        border: 1px solid #2563eb;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
        text-decoration: none;
        display: inline-block;
      }
      .btn-action:hover {
        background-color: #0039b5;
      }
      .btn-action:hover {
        background-color: #2563eb;
        color: #ffffff;
      }
      .btn-outline {
        background: none;
        color: #9ca3af;
        border: 1px solid #2a2e38;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
      }
      .btn-outline:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      @media (max-width: 767.98px) {
        .content {
          margin-left: 0;
        }
        .content .container-fluid {
          padding-left: 15px;
          padding-right: 15px;
        }
        .filter-content {
          flex-direction: column;
          align-items: stretch;
        }
        .search-input,
        .filter-select {
          width: 100%;
        }
        .stats {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        .btn-mark-as-read {
          width: auto;
        }
        input[type="date"] {
          filter: invert(1) brightness(2); /* Adjusts to a light/white tone */
        }
      }

      .date-input-wrapper {
        position: relative;
        display: inline-block;
        margin-right: 10px; /* Adjust spacing between inputs */
      }

      .date-picker {
        border-radius: 7px;
        padding: 8px;
        border: 1px solid #2a2e38;
        width: 200px; /* Adjust as needed */
        font-size: 14px;
        background-color: #2a2e38; /* Background when no date is selected */
      }

      /* Style the default placeholder to blend with background */
      .date-picker:invalid {
        color: #2a2e38 !important; /* Blend yyyy/mm/dd with background */
        background-color: #2a2e38; /* Consistent background when empty */
      }

      /* Target Webkit-specific placeholder */
      .date-picker:invalid::-webkit-datetime-edit {
        color: #2a2e38 !important; /* Blend yyyy/mm/dd with background in Webkit */
        background-color: #2a2e38; /* Match input background */
      }

      /* Style when a date is selected */
      .date-picker:not(:invalid) {
        color: #ccc; /* Black text for selected date for better contrast */
      }

      /* Target Webkit-specific date text when selected */
      .date-picker:not(:invalid)::-webkit-datetime-edit {
        color: #ccc; /* Black text for selected date for better contrast */
      }

      /* Style the custom placeholder label */
      .placeholder-text {
        position: absolute;
        top: 50%;
        left: 10px;
        transform: translateY(-50%);
        color: white; /* Matches inline style */
        background-color: #2a2e38; /* Match input background when empty */
        padding: 0 12px; /* Wider appearance */
        min-width: 100px; /* Wider appearance */
        text-align: center; /* Center text */
        pointer-events: none;
        font-size: 14px;
        transition: all 0.2s ease;
      }

      /* Hide the label when the input has a value or is focused */
      .date-picker:focus + .placeholder-text,
      .date-picker:not(:invalid) + .placeholder-text {
        display: none;
      }

      /* Style the calendar picker indicator */
      .date-picker::-webkit-calendar-picker-indicator {
        filter: invert(48%) sepia(13%) saturate(3207%) hue-rotate(130deg)
          brightness(95%) contrast(80%);
        cursor: pointer;
        background-color: transparent; /* Ensure indicator doesn't clash */
      }

      .btn-mark-as-read {
        display: flex; /* Use flexbox for centering */
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        background-color: #2563eb;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        font-size: 14px;
        width: 130px; /* Fixed width */
        height: 40px; /* Fixed height */
        max-width: 130px;
        min-width: 130px;
        cursor: pointer;
        transition: background-color 0.2s;
        white-space: nowrap; /* Prevent text wrapping */
      }
      .sidebar {
        width: 250px;
        transition: width 0.5s ease;
        overflow: hidden; /* hides sidebar content while shrinking */
      }

      /* Sidebar default (visible) */
        .sidebar {
          width: 250px;              /* full width */
          transition: width 0.5s ease;
          overflow: hidden;          /* hide text/icons while shrinking */
        }

        /* Sidebar collapsed */
        .sidebar.open {
          width: 0;                  /* collapse to zero */
        }

        /* Content default (shrunken to make space for sidebar) */
        .content {
          margin-left: 250px;        /* push content over */
          width: calc(100% - 250px); 
          transition: margin-left 0.5s ease, width 0.5s ease;
        }

        /* Content expanded (when sidebar collapsed) */
        .content.open {
          margin-left: 0;            /* shift left */
          width: 100%;               /* take full width */
        }


    </style>
  </head>
  <body>
    <div class="container-fluid position-relative d-flex p-0">
      <!-- Spinner Start -->
      <div
        id="spinner"
        class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center"
      >
        <div
          class="spinner-border text-primary"
          style="width: 3rem; height: 3rem"
          role="status"
        >
          <span class="sr-only">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->

      <!-- Sidebar Start -->
      <div class="sidebar pe-4 pb-3">
        <nav class="navbar bg-secondary navbar-dark">
          <a href="index.html" class="navbar-brand mx-4 mb-3">
            <img
              src="img/AzaniaWhite.png"
              alt="Azania Logo"
              style="height: 45px"
            />
          </a>
          <!-- <div class="d-flex align-items-center ms-4 mb-4">
                    <div class="position-relative">
                        <img class="rounded-circle" src="img/user.jpg" alt="" style="width: 40px; height: 40px;">
                        <div
                            class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1">
                        </div>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">Employee Manager Demo</h6>
                        <span>Admin</span>
                    </div>
                </div> -->

          <div class="d-flex align-items-center ms-4 mb-4">
            <div class="position-relative">
              <img
                class="rounded-circle"
                src="img/user.jpg"
                alt=""
                style="width: 40px; height: 40px"
              />
              <div
                class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"
              ></div>
            </div>
            <div class="ms-3">
              <h6 class="mb-0" id="profile-name">
                <a
                  href="my-profile.html"
                  style="color: inherit; text-decoration: none"
                >
                  Loading...
                </a>
              </h6>
              <span>Manager</span>
            </div>
          </div>
          <div class="navbar-nav w-100">
            <a href="index.html" class="nav-item nav-link"
              ><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a
            >
            <a href="view-shifts.html" class="nav-item nav-link"
              ><i class="fa fa-calendar me-2"></i>View Shifts</a
            >
            <a href="overtime.html" class="nav-item nav-link"
              ><i class="fa fa-clock me-2"></i>Overtime QR</a
            >
            <a href="normalQR.html" class="nav-item nav-link"
              ><i class="fas fa-qrcode me-2"></i>Normal QR</a
            >
            <a href="payroll.html" class="nav-item nav-link"
              ><i class="fa fa-money-bill me-2"></i>Payroll</a
            >
            <div class="nav-item dropdown">
              <a
                href="#"
                class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
                ><i class="fa fa-user-plus me-2"></i>Registration</a
              >
              <div
                class="dropdown-menu bg-secondary border-0 rounded-0 rounded-bottom m-0 ps-3"
              >
                <a href="registration.html" class="dropdown-item ps-5"
                  ><i class="fa fa-user-edit me-2"></i>New</a
                >
                <!-- <a href="status.html" class="dropdown-item ps-5"><i
                                    class="fa fa-info-circle me-2"></i>Status</a> -->
              </div>
            </div>
            <a href="status.html" class="nav-item nav-link"
              ><i class="fa fa-info alt me-2"></i>Status</a
            >
            <a href="leave.html" class="nav-item nav-link"
              ><i class="fa fa-sign-out-alt me-2"></i>Leave</a
            >
            <a href="events.html" class="nav-item nav-link"
              ><i class="fa fa-calendar-day me-2"></i>Events</a
            >
            <a href="reports.html" class="nav-item nav-link"
              ><i class="fa fa-chart-bar me-2"></i>Reports</a
            >
          </div>
        </nav>
      </div>
      <!-- Sidebar End -->
      <!-- Content Start -->

      <div class="content">
        <!-- Navbar Start -->
        <!-- Add this to your index.html and other pages -->
        <div id="navbar-container">
          <nav
            class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0"
          >
            <a href="index.html" class="navbar-brand d-flex d-lg-none me-4">
              <h2 class="text-primary mb-0"><i class="fa fa-user-tie"></i></h2>
            </a>
            <a href="#" class="sidebar-toggler flex-shrink-0">
              <i class="fa fa-bars"></i>
            </a>
            <div class="navbar-nav align-items-center ms-auto">
              <!-- Messages dropdown -->
              <div class="nav-item dropdown me-3">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                >
                  <i class="fa fa-envelope me-lg-2"></i>
                  <span class="d-none d-lg-inline-flex">Messages</span>
                  <span
                    id="messageCount"
                    class="badge bg-success ms-1"
                    style="font-size: 0.75rem; display: none"
                    >0</span
                  >
                </a>
                <div
                  class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0"
                  style="width: 350px"
                >
                  <div
                    id="recent-messages"
                    class="overflow-auto"
                    style="max-height: 400px"
                  >
                    <div class="text-center py-3">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                  <hr class="dropdown-divider m-0" />
                  <a
                    href="message-employee.html"
                    class="dropdown-item text-center"
                    >See all messages</a
                  >
                </div>
              </div>

              <!-- Notification dropdown -->
              <div class="nav-item dropdown">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                >
                  <i class="fa fa-bell me-lg-2"></i>
                  <span class="d-none d-lg-inline-flex">Notifications</span>
                  <span
                    id="notificationCount"
                    class="badge bg-danger ms-1"
                    style="font-size: 0.75rem; display: none"
                    >0</span
                  >
                </a>
                <div
                  class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0"
                  style="width: 350px"
                >
                  <div
                    id="recent-notifications"
                    class="overflow-auto"
                    style="max-height: 400px"
                  >
                    <div class="text-center py-3">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                  <hr class="dropdown-divider m-0" />
                  <a
                    href="ViewAllNotifications.html"
                    class="dropdown-item text-center"
                    >See all notifications</a
                  >
                </div>
              </div>

              <!-- User dropdown -->
              <div class="nav-item dropdown">
                <a
                  href="#"
                  class="nav-link dropdown-toggle"
                  data-bs-toggle="dropdown"
                >
                  <img
                    class="rounded-circle me-lg-2"
                    src="img/user.jpg"
                    alt=""
                    style="width: 40px; height: 40px"
                  />
                  <span class="d-none d-lg-inline-flex" id="nav-profile-name"
                    >Loading...</span
                  >
                </a>
                <div
                  class="dropdown-menu dropdown-menu-end bg-secondary border-0 rounded-0 rounded-bottom m-0"
                >
                  <a href="my-profile.html" class="dropdown-item">My Profile</a>
                  <a href="#" class="dropdown-item" id="logoutBtn">Log Out</a>
                </div>
              </div>
            </div>
          </nav>
        </div>
        <!-- Navbar End -->
        <!-- Main Content -->
        <div class="container-fluid pt-4 px-4">
          <div class="row g-4">
            <div class="col-12">
              <div id="notification-app">
                <notification-panel
                  :manager-id="managerId"
                ></notification-panel>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Content End -->
    </div>
    <!-- JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="lib/chart/chart.min.js"></script>
    <script src="lib/easing/easing.min.js"></script>
    <script src="lib/waypoints/waypoints.min.js"></script>
    <script src="lib/owlcarousel/owl.carousel.min.js"></script>
    <script src="lib/tempusdominus/js/moment.min.js"></script>
    <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
    <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="js/components.js"></script>
    <script src="js/main.js"></script>
    <script src="js/vue-init-null.js"></script>


    <script>
const { createApp, ref, onMounted, computed } = Vue;

const managerId = localStorage.getItem("employeeId");
console.log("Manager ID from localStorage:", managerId);

if (!managerId) {
  console.error(
    "Manager ID not found in localStorage. Redirecting to login."
  );
  document.getElementById("notification-app").innerHTML =
    '<p>Please log in to view notifications. <a href="/signin.html">Log in</a></p>';
} else {
  createApp({
    data() {
      return { managerId };
    },
    components: {
      "notification-panel": {
        props: ["managerId"],
        template: `
          <div>
            <div class="stats" style="margin-top:55px">
              <p class="number-notifications">Notifications</p>
              <button class="btn-mark-as-read" @click="markAllAsRead" style="text-align: center;">Mark All As Read </button>
            </div>
            <div class="filter-card mb-4">
              <div class="filter-content">
                <div class="search-wrapper">
                  <span class="icon-search">üîç</span>
                  <input class="search-input" v-model="searchTerm" placeholder="Search notifications..." />
                </div>
                <select class="filter-select" v-model="selectedCategory">
                  <option value="all">All Categories</option>
                  <option value="leave_request">Leave</option>
                  <option value="shift_swap">Shift Swaps</option>
                  <option value="message">Messages</option>
                  <option value="attendance">Attendance</option>
                </select>
                <div class="date-input-wrapper">
                  <label for="start-date" class="placeholder-text" v-if="!startDate" style="color: white; background-color: #2a2e38;">Start Date</label>
                  <input
                    type="date"
                    v-model="startDate"
                    class="search-input date-picker"
                    id="start-date"
                    @input="handleInput"
                    style="border-radius: 7px;"
                  >
                </div>
                <div class="date-input-wrapper">
                  <label for="end-date" class="placeholder-text" v-if="!endDate" style="color: white; background-color: #2a2e38;">End Date</label>
                  <input
                    type="date"
                    v-model="endDate"
                    class="search-input date-picker"
                    id="end-date"
                    @input="handleInput"
                    style="border-radius: 7px;"
                  >
                </div>
              </div>
            </div>
            <div class="tabs-list mb-4">
              <button class="tab" :class="{ active: statusFilter === 'all' }" @click="statusFilter = 'all'">All</button>
              <button class="tab" :class="{ active: statusFilter === 'unread' }" @click="statusFilter = 'unread'">
                Unread <span class="tab-badge">{{ unreadCount }}</span>
              </button>
              <button class="tab" :class="{ active: statusFilter === 'read' }" @click="statusFilter = 'read'">Read</button>
            </div>
            <div v-if="isLoading" class="notification-card empty-state">
              <p>Loading notifications...</p>
            </div>
            <div v-else-if="error" class="notification-card empty-state">
              <p style="color: red;">{{ error }}</p>
            </div>
            <div v-else-if="filteredNotifications.length === 0" class="notification-card empty-state">
              <p>No matching notifications found.</p>
            </div>
            <div v-else v-for="n in filteredNotifications" :key="n.notification_id"
              class="notification-card" :class="{ unread: n.read_status === 'unread', message: n.type === 'message' }">
              <div class="card-header">
                <div class="card-left">
                  <span class="card-icon">{{ getIcon(n.type) }}</span>
                  <div>
                    <h3>{{ n.message }}</h3>
                    <p v-if="n.type === 'message'">From: {{ n.sender_name }}</p>
                    <div class="category-badge">{{ formatCategory(n.type) }}</div>
                  </div>
                </div>
                <div class="card-right">
                  <span class="timestamp">{{ formatTime(n.sent_time) }}</span>
                  <button class="btn btn-primary btn-mark-as-read" @click="toggleRead(n)">
                      {{ n.read_status === 'read' ? 'Mark as Unread' : 'Mark as Read' }}
                  </button>
                </div>
              </div>
              <div class="card-actions" v-if="getAction(n)">
                <a v-if="getAction(n).type === 'message-employee' || n.type === 'message'" 
                   href="#" 
                   class="btn-action" 
                   @click.prevent="handleMessageClick(n)">
                  {{ getAction(n).text }}
                </a>
                <a v-else :href="getAction(n).link" class="btn-action">{{ getAction(n).text }}</a>
              </div>
            </div>
          </div>
        `,
        setup(props) {
          const notifications = ref([]);
          const isLoading = ref(true);
          const error = ref(null);
          const searchTerm = ref("");
          const selectedCategory = ref("all");
          const statusFilter = ref("unread");
          const startDate = ref("");
          const endDate = ref("");

          const fetchNotifications = async () => {
            isLoading.value = true;
            try {
              const response = await fetch(
                `http://localhost:3000/api/manager-notifications?employeeId=${props.managerId}`,
                { credentials: "include" }
              );
              if (!response.ok)
                throw new Error("Failed to fetch notifications");
              notifications.value = await response.json();
            } catch (err) {
              console.error("Error fetching notifications:", err);
              error.value = "Failed to load notifications";
            } finally {
              isLoading.value = false;
            }
          };

          const toggleRead = async (notification) => {
            try {
              const response = await fetch(
                `http://localhost:3000/api/manager-notifications/${
                  notification.notification_id
                }/${
                  notification.read_status === "read" ? "unread" : "read"
                }?employeeId=${props.managerId}`,
                {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ type: notification.type }),
                  credentials: "include",
                }
              );
              if (!response.ok)
                throw new Error("Failed to update notification status");
              await fetchNotifications();
            } catch (err) {
              console.error("Error toggling read status:", err);
              error.value = "Failed to update notification status";
            }
          };

          const markAllAsRead = async () => {
            try {
              const notificationIds = notifications.value.map((n) => ({
                id: n.notification_id,
                type: n.type,
              }));
              if (notificationIds.length === 0) return;

              const response = await fetch(
                "http://localhost:3000/api/manager-notifications/mark-all-read",
                {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    employeeId: props.managerId,
                    notificationIds,
                  }),
                  credentials: "include",
                }
              );
              if (!response.ok)
                throw new Error("Failed to mark all as read");
              await fetchNotifications();
            } catch (err) {
              console.error("Error marking all as read:", err);
              error.value = "Failed to mark all notifications as read";
            }
          };

          const filteredNotifications = computed(() => {
            let filtered = notifications.value;
            if (searchTerm.value) {
              const term = searchTerm.value.toLowerCase();
              filtered = filtered.filter((n) =>
                n.message.toLowerCase().includes(term)
              );
            }
            if (selectedCategory.value !== "all") {
              filtered = filtered.filter(
                (n) => n.type === selectedCategory.value
              );
            }
            if (statusFilter.value !== "all") {
              filtered = filtered.filter(
                (n) => n.read_status === statusFilter.value
              );
            }
            if (startDate.value || endDate.value) {
              const start = startDate.value
                ? new Date(startDate.value)
                : new Date(0);
              const end = endDate.value
                ? new Date(endDate.value)
                : new Date();
              filtered = filtered.filter((n) => {
                const notificationDate = new Date(n.sent_time);
                return (
                  notificationDate >= start && notificationDate <= end
                );
              });
            }
            return filtered;
          });

          const unreadCount = computed(() => {
            return notifications.value.filter(
              (n) => n.read_status === "unread"
            ).length;
          });

          const getIcon = (type) => {
            const icons = {
              leave_request: "üìÖ",
              shift_swap: "üîÑ",
              payroll: "üí∞",
              system: "‚öôÔ∏è",
              message: "‚úâÔ∏è",
              sick_note: "üìÑ",
              attendance: "üö®",
            };
            return icons[type] || "üì¢";
          };

          const formatCategory = (type) => {
            const categories = {
              leave_request: "Leave Request",
              shift_swap: "Shift Swap",
              payroll: "Payroll",
              system: "System",
              message: "Message",
              sick_note: "Sick Note",
              attendance: "Attendance",
            };
            return categories[type] || type;
          };

          const formatTime = (time) => new Date(time).toLocaleString();

          const getAction = (notification) => {
  console.log("getAction called with notification:", notification);
  
  // Handle sick note notifications
  if (notification.message.includes("sick note")) {
    // Check if we have the enriched data
    if (!notification.sick_note || !notification.employee_id) {
      console.error("Missing sick note data in notification:", notification);
      return {
        text: "View Sick Note",
        link: "#",
        disabled: true
      };
    }
    
    const employeeName = notification.employee_name || "";
    const startDate = notification.start_date || "";
    const endDate = notification.end_date || "";
    const daysTaken = notification.days_taken || "";
    
    const link = `/view-sick-note.html?note=${encodeURIComponent(
      notification.sick_note
    )}&employeeId=${notification.employee_id}&startDate=${startDate}&endDate=${endDate}&employeeName=${encodeURIComponent(
      employeeName
    )}&daysTaken=${daysTaken}`;
    
    console.log("Generated sick note link:", link);
    return { text: "View Sick Note", link };
  }
  
  // Handle message notifications
  if (notification.type === "message") {
    return {
      text: "View Message",
      type: "message-employee",
      link: `message-employee.html?employeeId=${notification.sender_id || ""}`
    };
  }
  
  // Handle attendance notifications
  if (notification.type === "attendance") {
    // Exclude replacement-related messages from having "Message Employee" action
    if (
      notification.message.startsWith("Replacement Successful") ||
      notification.message.startsWith("Shift Replacement Successful") ||
      notification.message.startsWith("Shift Replacement Failed") ||
      notification.message.startsWith("Replacement employee")
    ) {
      return null;
    }
    return {
      text: "Message Employee",
      type: "message-employee",
      link: `message-employee.html?employeeId=${notification.employee_id || ""}`
    };
  }
  
  // Handle other notification types
  const actions = {
    leave_request: {
      text: "View Request",
      link: `leave.html?id=${notification.notification_id}`
    },
    shift_swap: {
      text: "View Swap",
      link: `view-shifts.html?id=${notification.notification_id}`
    },
    payroll: {
      text: "View Payroll",
      link: `payroll.html?id=${notification.notification_id}`
    }
  };
  
  return actions[notification.type] || null;
};

          const handleMessageClick = async (notification) => {
            try {
              // Mark notification as read
              await fetch(
                `http://localhost:3000/api/manager-notifications/${notification.notification_id}/read?employeeId=${props.managerId}`,
                {
                  method: "PATCH",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    type: notification.type,
                  }),
                  credentials: "include",
                }
              );

              let employeeId =
                notification.sender_id || notification.employee_id;

              // For attendance notifications, try to resolve employeeId from name if necessary
              if (notification.type === "attendance" && !employeeId) {
                // Regex to handle multiple attendance notification formats
                const match = notification.message.match(
                  /^([A-Za-z'-]+ [A-Za-z'-]+)/
                );
                if (match) {
                  const name = match[1].trim();
                  try {
                    const response = await fetch(
                      `http://localhost:3000/api/employees/search?name=${encodeURIComponent(
                        name
                      )}`,
                      { credentials: "include" }
                    );
                    if (!response.ok) {
                      throw new Error(
                        `Employee search failed: ${response.statusText}`
                      );
                    }
                    const employee = await response.json();
                    if (employee.employee_id) {
                      employeeId = employee.employee_id;
                    } else if (
                      employee.error ===
                      "Multiple employees found with the same name; contact admin"
                    ) {
                      error.value =
                        "Multiple employees found with the same name. Please contact admin.";
                      return;
                    } else {
                      throw new Error("Employee not found");
                    }
                  } catch (err) {
                    console.error(
                      "Error fetching employee by name:",
                      err
                    );
                    error.value = `Unable to message employee: ${err.message}`;
                    return;
                  }
                } else {
                  console.error(
                    "Could not parse employee name from notification:",
                    notification
                  );
                  error.value =
                    "Unable to message employee: Invalid notification format";
                  return;
                }
              }

              if (!employeeId) {
                console.error(
                  "No valid employeeId found for notification:",
                  notification
                );
                error.value =
                  "Unable to message employee: Invalid employee ID";
                return;
              }

              // Redirect to chat portal
              window.location.href = `message-employee.html?employeeId=${employeeId}`;
            } catch (err) {
              console.error("Error handling message click:", err);
              error.value = `Failed to open chat: ${err.message}`;
            }
          };

          const handleInput = () => {
            // Trigger re-computation of filteredNotifications
          };

          onMounted(() => {
            fetchNotifications();
          });

          return {
            notifications,
            isLoading,
            error,
            searchTerm,
            selectedCategory,
            statusFilter,
            startDate,
            endDate,
            filteredNotifications,
            unreadCount,
            getIcon,
            formatCategory,
            formatTime,
            getAction,
            toggleRead,
            markAllAsRead,
            handleMessageClick,
            handleInput,
          };
        },
      },
    },
  }).mount("#notification-app");
}
</script>
  </body>
</html>
